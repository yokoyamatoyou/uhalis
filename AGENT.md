# **リファクタリング指示書: テキストモデレーションツール (AGENT.md)**

## **1\. 概要**

本ドキュメントは、SNS用攻撃性判定.py で実装されているテキストモデレーションツールのリファクタリングに関する指示を定義する。主な目的は、ユーザー体験の向上、分析精度の向上、そして将来的な機能拡張を容易にするための保守性の確保である。

## **2\. AIモデルの指定**

* **使用モデル**: gpt-4.1-mini-2025-04-14  
* **指示**: 現在、攻撃性スコアの算出に gpt-4.1-mini-2025-04-14 が使用されている。このモデルを引き続き使用し、ツール全体で利用するモデルとして統一する。将来的にモデルを変更する可能性を考慮し、モデル名を定数または設定ファイルで管理すること。

## **3\. UI/UXの改善**

### **3.1. タブ付きインターフェースの導入**

現状の課題:  
すべてのUIコンポーネントが単一のウィンドウに配置されており、機能が増えるにつれて煩雑になる可能性がある。  
**改善指示:**

* customtkinter の CTkTabview を使用して、UIを「メイン」タブと「設定」タブに分割する。  
  * **メインタブ**: ファイル選択、分析実行、進捗表示、結果保存など、主要な操作を集約する。  
  * **設定タブ**: パラメータ調整や後述する重み付け設定など、詳細な設定項目を配置する。

### **3.2. 分析対象列の動的選択機能**

現状の課題:  
分析対象の列名が '投稿内容' という文字列でハードコーディングされているため、異なるフォーマットのExcelファイルに対応できない。  
**改善指示:**

1. Excelファイル読み込み後、pandas を用いてファイルのヘッダー（列名）をすべて取得する。  
2. 取得した列名を customtkinter の CTkComboBox（ドロップダウンリスト）に設定する。  
3. ユーザーがこのドロップダウンリストから分析したい列（例: '投稿', 'POST', 'テキスト'など）を選択できるようにする。  
4. 分析実行時は、ここで選択された列を対象として処理を行う。

### **3.3. 総合攻撃性スコアの重み付け設定機能**

現状の課題:  
総合攻撃性スコアを算出する際の各項目の重み付けがソースコード内にハードコーディングされており、ユーザーが調整できない。  
**改善指示:**

1. 「設定」タブ内に、総合攻撃性スコアの計算に使用する各項目（hate\_score, aggressiveness\_score など）の重み付けを調整するためのUIを設ける。UIには CTkSlider や CTkEntry を使用する。  
2. **動的な重み配分:**  
   * 各項目の重みの合計値（例: 1.0）を基準とする。  
   * ユーザーが一つのスライダーを動かして重みを変更すると、他の項目に分配（または他の項目から削減）する必要があることを明示する。  
   * UI上に「未分配の重み: 0.XX」のように、残りの重みや超過分をリアルタイムで表示するラベルを設置する。  
   * 合計値が基準を超えている場合は警告色（例: 赤色）で表示し、分析実行ボタンを無効化するなど、ユーザーが誤った設定で分析できないように制御する。

## **4\. プロンプトの最適化 (Few-shot Learningの導入)**

現状の課題:  
プロンプトがZero-shot（例を提示しない）形式であり、モデルの出力が不安定になる可能性がある。  
改善指示:  
get\_aggressiveness\_score メソッド内のシステムプロンプトを改善し、Few-shot learningの手法を導入する。これにより、モデルに対してより明確な指示を与え、評価の精度と一貫性を向上させる。  
**プロンプト改善案:**

あなたはソーシャルメディアの投稿を分析し、その攻撃性を評価する専門家です。  
以下の評価基準と例を参考に、与えられた文章の攻撃性スコアを0から9の整数で決定し、その理由を40〜60文字で簡潔に説明してください。

\# 評価基準:  
\- 0: 攻撃性なし。中立的で誰に対しても敵意が感じられない。  
\- 1-2: 非常に軽度の攻撃性。配慮に欠ける表現だが、攻撃意図が明確ではない。  
\- 3-4: 軽度の攻撃性。間接的な批判や皮肉が含まれている。  
\- 5-6: 中程度の攻撃性。明確な批判や侮辱的な表現が見られる。  
\- 7-8: 高度の攻撃性。強い侮辱や敵意を伴う表現。  
\- 9: 極度の攻撃性。暴力的な脅迫や人権侵害を伴うような非常に攻撃的な内容。

\# 評価例:  
\---  
\- 文章: 「この映画、正直言って時間の無駄だったな。」  
\- スコア: 3  
\- 理由: 個人的な感想だが、作品を否定するやや強い表現が使われているため。  
\---  
\- 文章: 「新製品の発表会、楽しみにしてます！応援してます！」  
\- スコア: 0  
\- 理由: 攻撃的な要素はなく、ポジティブで応援する内容であるため。  
\---  
\- 文章: 「あいつのせいで全部台無しだ。絶対に許さない。」  
\- スコア: 8  
\- 理由: 特定の個人への強い敵意と攻撃的な言葉が明確に含まれているため。  
\---

\# 分析対象の文章:  
{text}

\# 回答形式:  
スコア: \[0-9の整数\]  
理由: \[40-60文字での具体的な理由\]

## **5\. その他の提案 (保守性・拡張性の向上)**

### **5.1. コードのモジュール化**

* **指示**: 現在の単一ファイルのスクリプトを、責務に応じて複数のファイルに分割する。  
  * main.py: アプリケーションのエントリーポイント、ModerationApp のインスタンス化と実行。  
  * ui.py: ModerationApp クラス（UIの構築とイベントハンドリング）。  
  * analyzer.py: テキスト分析ロジック（API呼び出し、スコア計算など）を担当するクラス。  
  * config.py: モデル名、APIキー、デフォルトの重み付けなどの設定値を管理。

### **5.2. 設定の永続化**

* **指示**: ユーザーが「設定」タブで変更した重み付けや、選択したAIモデルなどの設定を、ローカルファイル（例: config.json）に保存する機能を実装する。アプリケーション起動時にこのファイルを読み込み、前回の設定を復元できるようにする。

### **5.3. 非同期処理によるUIフリーズの防止**

* **指示**: asyncio と aiohttp などを導入し、時間のかかるAPIリクエストを非同期処理に切り替える。これにより、分析中にUIがフリーズするのを防ぎ、ユーザー体験を向上させる。プログレスバーの更新もよりスムーズになる。

### **5.4. エラーハンドリングの強化**

* **指示**: APIからの予期せぬレスポンス（レートリミットエラー、サーバーエラーなど）や、ネットワーク接続の問題に対応するための、より堅牢なエラーハンドリングとリトライ処理を実装する。